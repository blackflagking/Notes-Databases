1、禁用sga自动管理机制，分配比较小的数据缓冲区(30m)和共享池(70m)空间，关闭PGA自动调优，分配（30m）。同时部署sp，每隔5分钟产生一个快照，快照的级别为7级。

##准备工作   

###禁用sga自动管理机制：  
```
SYS@prod>show parameter memory_target

NAME                     TYPE    VALUE
------------------------------------ ----------- ------------------------------
memory_target                big integer 500M

SYS@prod>alter system  set memory_target=0;

系统已更改。

SYS@prod>show parameter memory_target

NAME                     TYPE    VALUE
------------------------------------ ----------- ------------------------------
memory_target                big integer 0

SYS@prod>alter system  set sga_target=0;

系统已更改。

SYS@prod>show parameter sga_target

NAME                     TYPE    VALUE
------------------------------------ ----------- ------------------------------
sga_target               big integer 0
```

### 分配较小的数据缓冲区：
```
SYS@prod>show parameter db_cache_size

NAME                     TYPE    VALUE
------------------------------------ ----------- ------------------------------
db_cache_size                big integer 180M

SYS@prod>alter system set db_cache_size=30m;

系统已更改。

SYS@prod>show parameter db_cache_size

NAME                     TYPE    VALUE
------------------------------------ ----------- ------------------------------
db_cache_size                big integer 32M
```

### 分配较小的数据共享池70M
```shell
SYS@prod>alter system set shared_pool=70m
ORACLE 例程已经启动。

系统已更改。

SYS@prod>show parameter shared_pool_size

NAME                     TYPE    VALUE
------------------------------------ ----------- ------------------------------
shared_pool_size             big integer 72M
```
##创建序列：
```
CREATE SEQUENCE emp2_empno
           START WITH 1
      INCREMENT BY 1
      MAXVALUE 100000000
      CACHE 10000
      NOCYCLE;
```
##往表中插入数据：  
```shell
SCOTT@prod>  create table emp2 as select * from emp where 1=2;
SCOTT@prod>  alter table emp2 modify empno number(10);
SCOTT@prod>  alter table emp2 modify ENAME varchar2(30);
SCOTT@prod>  alter table emp2 nologging;

begin
  for i in 1..20000000 loop
    insert into emp2 nologging
    values (emp2_empno.nextval,'cuug'||i,'SALESMAN',7698,sysdate,1600,300,30);
    if mod(i,1000)=0 then 
    commit;
    end if;
  end loop;
  commit;
end;  
/



drop sequence emp2_empno;
```


1)SYS@ prod>@?/rdbms/admin/spcreate.sql

2)调整快照收集的级别，缺省是level=5，改成level=7
PERFSTAT@prod>exec statspack.MODIFY_STATSPACK_PARAMETER(I_SNAP_LEVEL=>7);   类似AWR报告中的STATISTICS_LEVEL参数

用job配置定时产生Statspack的快照，这一步在AWR中默认1小时。我这里为了测试改为每隔5分钟自动建立一次快照
[oracle@cuug admin]$ cd $ORACLE_HOME/rdbms/admin
[oracle@cuug admin]$ cp spauto.sql spauto.sql.bak   把它备份一下，实验完成后再还原
[oracle@cuug admin]$ vi spauto.sql

把dbms_job.submit(:jobno, 'statspack.snap;', trunc(sysdate+1/24,'HH'), 'trunc(SYSDATE+1/24,''HH'')', TRUE, :instno);
换成
dbms_job.submit(:jobno,'statspack.snap;',trunc(sysdate+1/1440,'MI'), 'trunc(SYSDATE+5/1440,''MI'')', TRUE, :instno);
然后wq!保存退出.
从sysdate+1分钟（取整）开始采集快照，下一次时间间隔是当前的时间+5分钟（取整）。这里24小时是1440分钟，那么1/1440就是一分钟

### 执行spauto.sql
PERFSTAT@ prod>@?/rdbms/admin/spauto.sql
等待出三个快照，每5分钟一个

### 查看当前运行的job

PERFSTAT@ prod>select job,what from dba_jobs where what like '%statspack%';
       JOB WHAT
---------- --------------------------------------------------
        23 statspack.snap;

列出有多少快照
PERFSTAT@ prod>select snap_id,snap_time from stats$snapshot;




### 模拟查询业务
```shell
[oracle@db bin]$ more share_pool_sql_1.sh 
#!/bin/bash

CNT=1
while [ $CNT -lt 20000000 ]
do
sqlplus scott/scott <<EOF
select * from emp2 where empno=$CNT;
exit
EOF
CNT=`expr $CNT + 1`
done  
```

### 指定两个快照，生成Statspack报告
PERFSTAT@ prod>@?/rdbms/admin/spreport.sql
给报告起个名字，比如：/home/oracle/prod_report, 这个报告给了路径了，否则就放在当前目录中。



### 删除第四步中你建立的job。
查看一下job号
SQL> col what for a60;
PERFSTAT@ prod>select job,what from dba_jobs where what like '%statspack%';
23 statspack.snap;
PERFSTAT@ prod>exec dbms_job.remove(23);   删除23号job

### 恢复配置前的状态
还原spauto.sql脚本，恢复原配置，默认不收集SP快照
[oracle@cuug admin]$ cp spauto.sql.bak spauto.sql
SQL> @?/rdbms/admin/spdrop.sql   需要运行脚本做删除，不能仅仅删除perfstat用户名








表空间名                       表空间大小(M) 已使用空间(M) 使用比   空闲空间(M)  最大块(M)
------------------------------ ------------- ------------- -------- ----------- ----------
EXAMPLE             313.13      310.19   99.06%    2.94       1.88
SYSAUX           650      614.44   94.53%   35.56   33
SYSTEM           750      744.87   99.32%    5.13    4
USERS         1285     1223.06   95.18%   61.94   61